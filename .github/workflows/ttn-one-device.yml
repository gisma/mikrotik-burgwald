name: TTN all devices → Pages

on:
  schedule:
    - cron: "*/15 * * * *"     # alle 15 Minuten
  workflow_dispatch:

permissions:
  contents: write

# Nur ein Lauf gleichzeitig (verhindert Push-Rennen)
concurrency:
  group: ttn-pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TTN_APP_ID:  ${{ secrets.TTN_APP_ID }}
      TTN_REGION:  ${{ secrets.TTN_REGION }}
      TTN_API_KEY: ${{ secrets.TTN_API_KEY }}
      # optional: Standard-Theme fürs Dashboard ("light"|"dark")
      THEME_DEFAULT: "light"

    steps:
      - name: Checkout (full history for rebase)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas plotly pyarrow python-dotenv

      - name: Build dashboard (pull all devices)
        run: |
          # baut assets/data.html, assets/debug.html, assets/theme-ecowitt.css etc.
          python scripts/pull_all_devices.py

          # nach docs/assets kopieren (wird von Pages ausgeliefert)
          mkdir -p docs/assets
          cp -r assets/* docs/assets/ || true

      - name: Publish data to docs/data
        run: |
          mkdir -p docs/data
          # nur gewünschte Dateitypen übernehmen
          cp -a data/*.parquet docs/data/ 2>/dev/null || true
          cp -a data/*.ndjson  docs/data/ 2>/dev/null || true

      - name: Build data index (JSON)
        run: |
          python - << 'PY'
          import json, pathlib
          d = pathlib.Path("docs/data")
          d.mkdir(parents=True, exist_ok=True)
          items = []
          for p in sorted(d.glob("*")):
              if p.suffix.lower() not in (".parquet", ".ndjson"):
                  continue
              st = p.stat()
              items.append({
                  "name": p.name,
                  "size": st.st_size,
                  "mtime": int(st.st_mtime),
                  "type": "Parquet" if p.suffix.lower()==".parquet" else "NDJSON"
              })
          (d / "index.json").write_text(json.dumps(items, ensure_ascii=False), encoding="utf-8")
          PY

      # Sicheres Committen mit Rebase vor Push
      - name: Commit docs/ and data/ (with rebase)
        env:
          BRANCH: ${{ github.ref_name }}
        run: |
          set -e
          git config user.name  "ttn-bot"
          git config user.email "ttn-bot@example.com"

          # Branch sicherstellen (Runner ist oft detached)
          git checkout "$BRANCH"

          # Remote-Änderungen einziehen (ohne Merge-Commit)
          git pull --rebase origin "$BRANCH" || true

          git add docs/ data/ || true
          git commit -m "update all-devices $(date -u +%FT%TZ)" || echo "no changes"

          git push origin "$BRANCH"

name: TTN all devices â†’ Pages

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TTN_API_KEY:  ${{ secrets.TTN_API_KEY }}
      TTN_APP_ID:   ${{ secrets.TTN_APP_ID }}
      TTN_REGION:   ${{ secrets.TTN_REGION }}
      TTN_AFTER_DAYS: "2"
      RUN_DASH: "1"
      DELAY_BETWEEN_DEVICES: "0.4"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas plotly pyarrow fastparquet python-dotenv

      - name: Build dashboard (auto-discovery)
        run: |
          python scripts/pull_all_devices.py
          mkdir -p docs
          cp -r assets/* docs/
          # zur Kontrolle: welche Devices wurden gefunden?
          [ -f assets/devices_used.txt ] && cp assets/devices_used.txt docs/

      - name: Commit docs/ and data/
        run: |
          git config user.name  "ttn-bot"
          git config user.email "ttn-bot@example.com"
          git add docs/ data/ || true
          git diff --cached --quiet || git commit -m "update all-devices $(date -u +%FT%TZ)"
          git push

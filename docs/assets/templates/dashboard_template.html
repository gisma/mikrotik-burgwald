<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TTN Dashboard – Light</title>

{{STYLE}}
<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --text:#0b1221; --muted:#334155;
    --border:#cbd5e1; --shadow:0 1px 10px rgba(2,6,23,.06);
    --accent:#111827; --th:#f1f5f9;
  }
  html,body{background:var(--bg)}
  body{
    font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
    margin:20px; color:var(--text);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  h1{margin:0 0 .6rem; font-weight:700; letter-spacing:.1px}
  h2{margin:0 0 .5rem; font-weight:700}
  h3,h4{margin:0 0 .4rem; font-weight:600}
  small{color:var(--muted)}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px; box-shadow:var(--shadow);
    padding:16px; margin:16px 0;
  }

  /* Tabs */
  .tabs{display:flex; gap:10px; margin:10px 0 14px}
  .tabs button{
    border:1px solid var(--border);
    background:#fff; color:var(--text);
    border-radius:10px; padding:8px 14px; cursor:pointer;
    font-weight:600;
  }
  .tabs button.active{background:var(--accent); color:#fff; border-color:var(--accent)}
  [hidden]{display:none !important}

  /* Value cards */
  .val-grid{display:grid; grid-template-columns:repeat(3,minmax(260px,1fr)); gap:14px}
  .val-card{
    background:#fff; border:1px solid var(--border); border-radius:12px;
    padding:14px; box-shadow:var(--shadow);
  }
  .val-card h4{margin:.1rem 0 .7rem; font-weight:700}
  .vals{display:grid; grid-template-columns:1fr 1fr; gap:8px 12px}
  .kv{display:contents}
  .kv .k{color:var(--muted); font-weight:600}
  .kv .v{color:var(--text); text-align:right; font-weight:700; font-size:1.05rem}
  @media (max-width:1100px){ .val-grid{grid-template-columns:repeat(2,minmax(240px,1fr))} }
  @media (max-width:700px){ .val-grid{grid-template-columns:1fr} }

  /* Plot-Kacheln */
  .type-grid{display:grid; grid-template-columns:1fr; gap:16px}
  .device-grid{display:grid; grid-template-columns:repeat(2,minmax(320px,1fr)); gap:14px; margin-top:12px}
  .device-tile{border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; box-shadow:var(--shadow)}
  .device-tile h4{margin:.2rem 0 .6rem; font-size:15px; color:var(--text)}
  .plot-wrap{border:1px solid var(--border); border-radius:10px; padding:6px; margin-bottom:10px; background:#fff}
  @media (max-width:900px){ .device-grid{grid-template-columns:1fr} }

  /* Tabellen */
  table{border-collapse:collapse; width:100%}
  th,td{border:1px solid var(--border); padding:8px 10px; text-align:left; font-size:.95rem}
  th{background:var(--th); color:#0f172a; font-weight:700}

  /* Badges */
  .badge{display:inline-block; padding:.15rem .5rem; border-radius:999px; font-size:.8rem; font-weight:700; border:1px solid transparent}
  .badge.ok{background:#e1f7e6; color:#065f46; border-color:#a7f3d0}
  .badge.stale{background:#fff4e6; color:#92400e; border-color:#fed7aa}
  .badge.empty{background:#f1f5f9; color:#334155; border-color:#cbd5e1}
  .badge.err{background:#fee2e2; color:#991b1b; border-color:#fecaca}

  /* Info-Tab */
  .info-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
  @media (max-width:1200px){ .info-grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:800px){ .info-grid{grid-template-columns:1fr} }
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.92rem}
  code{background:#eef2f6; padding:.1rem .35rem; border:1px solid #dbe3ea; border-radius:6px}
  pre{background:#0b1221; color:#e5e7eb; padding:12px; border-radius:10px; overflow:auto}
</style>

<h1>TTN Dashboard – Grouped by Sensor Type</h1>
<small>As of: {{STAMP}} • Source: TTN Storage ({{APP}}@{{REG}}) • Window: last {{AFTER_DAYS}} days • AFTER={{AFTER}}</small>

<div class="tabs">
  <button class="active" data-tab="overview">Übersicht</button>
  <button data-tab="charts">Diagramme</button>
  <button data-tab="debug">Debug</button>
  <button data-tab="info">Info</button>
</div>

<section id="tab-overview">
  <div class="card">
    <h2>Übersicht (aktuelle Werte)</h2>
    {{OVERVIEW_CARDS}}
  </div>

  <div class="card">
    <h2>Geräte-Tabelle</h2>
    {{OVERVIEW_TABLE}}
    <p style="margin-top:8px"><small>
      Parquet: <code>data/&lt;device&gt;.parquet</code> •
      CSV: <code>data/&lt;device&gt;.csv</code> •
      NDJSON (raw): <code>data/&lt;device&gt;_raw.ndjson</code>
    </small></p>
  </div>
</section>

<section id="tab-charts" hidden>
  <div class="type-grid">
    {{TYPE_CARDS}}
  </div>
</section>

<section id="tab-debug" hidden>
  {{DEBUG_CARDS}}
</section>

<!-- Info-Tab -->
<section id="tab-info" hidden>
  <div class="card">
    <h2>Allgemeine Formate im Repo</h2>
    <div class="info-grid">
      <div>
        <h3>NDJSON (Newline Delimited JSON)</h3>
        <ul>
          <li>Jede Zeile ein JSON-Objekt → ideal für Streaming &amp; APIs.</li>
          <li>Direkt auswertbar mit <code>jq</code>, <code>pandas.read_json(..., lines=True)</code>, <code>jsonlite::stream_in()</code>.</li>
        </ul>
        <pre class="mono"># bash / jq
head -n 3 data/&lt;device&gt;_raw.ndjson | jq .
# Python / pandas
import pandas as pd
df = pd.read_json("data/&lt;device&gt;_raw.ndjson", lines=True)</pre>
        <p><small>Hinweis: <code>data/&lt;device&gt;_raw.ndjson</code> enthält die rohen TTN-Storage-Antworten pro Pull (optional append/snapshot).</small></p>
      </div>

      <div>
        <h3>Parquet</h3>
        <ul>
          <li>Spaltenorientiert, binär, sehr kompakt &amp; schnell.</li>
          <li>Für Analysen/Abfragen optimiert – Standard in Spark, DuckDB, BigQuery etc.</li>
        </ul>
        <pre class="mono"># Python / pandas
import pandas as pd
df = pd.read_parquet("data/&lt;device&gt;.parquet")</pre>
        <p>Typischer Workflow: Rohdaten zuerst als NDJSON persistieren → für Analyse/Archiv in Parquet konvertieren.</p>
      </div>

      <div>
        <h3>CSV</h3>
        <ul>
          <li>Mensch- &amp; toollesbar, maximal interoperabel (Excel, R, GIS, Shell).</li>
          <li>Wird vom Script zusätzlich zu Parquet erzeugt: <code>data/&lt;device&gt;.csv</code>.</li>
        </ul>
        <pre class="mono"># Python / pandas (mit Timestamps)
import pandas as pd
df = pd.read_csv("data/&lt;device&gt;.csv", parse_dates=["received_at"])
# Schnellblick (Shell)
head -n 3 data/&lt;device&gt;.csv</pre>
        <p><small>Hinweis: Das Script **liest bevorzugt Parquet** (Performance). CSV dient als offenes Austauschformat und Fallback.</small></p>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Sensoren &amp; Felder</h2>
    <table>
      <thead>
        <tr>
          <th>Sensor</th>
          <th>Wichtige Felder</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>DDS75-LB</strong> <small>(<code>dds75-lb-*.parquet</code>)</small></td>
          <td><code>distance_cm</code> (bzw. <code>Distance_mm</code>), <code>temperature</code>, <code>battery</code>, Flags: <code>interrupt_flag</code>, <code>sensor_flag</code></td>
        </tr>
        <tr>
          <td><strong>PS-LB</strong> <small>(<code>burgwald-ps-lb-*.parquet</code>)</small></td>
          <td><code>water_cm</code> bzw. <code>pressure_kpa</code>/<code>pressure_mpa</code>, zusätzlich <code>idc_input_ma</code>, <code>vdc_input_v</code>, <code>battery</code>, digitale Eingänge</td>
        </tr>
        <tr>
          <td><strong>SenseCAP</strong> <small>(<code>burgwald-sensecap-*.parquet</code>)</small></td>
          <td><code>temperature</code>, <code>humidity</code>, <code>pressure_hpa</code>, <code>illumination</code>, ggf. <code>uv_index</code>, <code>wind_speed</code>, <code>wind_dir</code>, <code>rainfall</code></td>
        </tr>
      </tbody>
    </table>
    <p style="margin-top:8px"><small>Hinweis: Das Dashboard gruppiert Devices automatisch nach Sensor-Typ und zeigt Betriebswerte (Battery/RSSI/SNR/Power) in einem Sammel-Diagramm.</small></p>
  </div>
</section>

{{TABS_JS}}

<!-- Tab-Handling inkl. Info-Tab -->
<script>
  (function(){
    const buttons = document.querySelectorAll('.tabs button');
    const sections = document.querySelectorAll('section[id^="tab-"]');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const name = btn.dataset.tab;
        sections.forEach(sec => { sec.hidden = (sec.id !== `tab-${name}`); });
        buttons.forEach(b => b.classList.toggle('active', b === btn));
      });
    });
  })();
</script>
